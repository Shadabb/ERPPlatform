@page "/log-analytics/serilog-dashboard"
@using ERPPlatform.LogAnalytics
@model ERPPlatform.Web.Pages.LogAnalytics.SerilogDashboardModel
@{
    ViewData["Title"] = "Serilog Analytics Dashboard";
}

@Html.AntiForgeryToken()

@section styles {
    <link href="~/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Pages/LogAnalytics/Dashboard.css" rel="stylesheet" />
    <link href="~/Pages/LogAnalytics/SerilogDashboard.css" rel="stylesheet" asp-append-version="true" />
}

<div class="serilog-analytics-dashboard">
    <!-- Header -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2><i class="fas fa-server"></i> Serilog Analytics Dashboard</h2>
                <p class="text-muted">Application performance monitoring and structured logging analytics</p>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-outline-success" id="exportBtn">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-cog"></i> Auto Refresh
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-refresh="0">Manual</a></li>
                            <li><a class="dropdown-item" href="#" data-refresh="30">30 seconds</a></li>
                            <li><a class="dropdown-item" href="#" data-refresh="60">1 minute</a></li>
                            <li><a class="dropdown-item" href="#" data-refresh="300">5 minutes</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Date Range Filter (Collapsible) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#dateFilters" style="cursor: pointer;">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> Date Range Filters
                        <i class="fas fa-chevron-down float-end"></i>
                    </h6>
                </div>
                <div id="dateFilters" class="collapse">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">From Date</label>
                                <input type="datetime-local" id="fromDate" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">To Date</label>
                                <input type="datetime-local" id="toDate" class="form-control">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="window.serilogDashboard.loadDashboard()">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Row -->
    <div class="row mb-4" id="summaryCards">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="metric-icon bg-primary">
                    <i class="fas fa-list-alt"></i>
                </div>
                <div class="metric-info">
                    <h3 id="totalLogs">-</h3>
                    <p>Total Log Entries</p>
                    <small class="text-muted">Serilog data</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="metric-icon bg-success">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-info">
                    <h3><span id="avgResponseTime">-</span>ms</h3>
                    <p>Avg Response Time</p>
                    <small class="text-muted">Performance</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="metric-icon bg-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="metric-info">
                    <h3><span id="errorRate">-</span>%</h3>
                    <p>Error Rate</p>
                    <small class="text-muted">Requires attention</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card" id="healthCard">
                <div class="metric-icon bg-info">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="metric-info">
                    <h3 id="systemHealth">-</h3>
                    <p>System Health</p>
                    <small class="text-muted">Current status</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Performance Trends Chart -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-line"></i>
                            Performance Trends (Last 24 Hours)
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="100"></canvas>
                    </div>
                </div>
            </div>

            <!-- Log Level Distribution -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie"></i>
                            Log Level Distribution
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="logLevelChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Recent Errors -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-exclamation-circle text-danger"></i>
                            Recent Errors
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-danger" id="errorCount">0</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="recentErrorsContainer">
                            <div class="text-center p-3">
                                <i class="fas fa-spinner fa-spin"></i> Loading errors...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slow Requests -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-turtle text-warning"></i>
                            Slow Requests
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-warning" id="slowRequestCount">0</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="slowRequestsContainer">
                            <div class="text-center p-3">
                                <i class="fas fa-spinner fa-spin"></i> Loading slow requests...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Top Endpoints Performance -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-server"></i>
                            Top Endpoints Performance
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm" id="endpointsTable">
                                <thead>
                                    <tr>
                                        <th>Endpoint</th>
                                        <th>Request Count</th>
                                        <th>Avg Duration</th>
                                        <th>Max Duration</th>
                                        <th>Error Rate</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="endpointsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading endpoints...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Search Modal -->
        <div class="modal fade" id="searchModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Advanced Log Search</h4>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="advancedSearchForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Log Level</label>
                                        <select id="searchLogLevel" class="form-control">
                                            <option value="">All Levels</option>
                                            <option value="Information">Information</option>
                                            <option value="Warning">Warning</option>
                                            <option value="Error">Error</option>
                                            <option value="Fatal">Fatal</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>User ID</label>
                                        <input type="text" id="searchUserId" class="form-control" placeholder="Filter by user...">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Min Duration (ms)</label>
                                        <input type="number" id="searchMinDuration" class="form-control" placeholder="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Request Path</label>
                                        <input type="text" id="searchRequestPath" class="form-control" placeholder="Filter by endpoint...">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Search Text</label>
                                <input type="text" id="searchText" class="form-control" placeholder="Search in message content...">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="performSearch">Search</button>
                    </div>
                </div>
            </div>
        </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/Pages/LogAnalytics/SerilogDashboard.js" asp-append-version="true"></script>
}